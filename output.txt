 
    

       
            
       
       
       
      


equation#2#1#3


c

  


rgb0,0.6,0



    backgroundcolor=,   
    commentstyle=,
    keywordstyle=,
    numberstyle=codegray,
    stringstyle=,
    basicstyle=,
    breakatwhitespace=false,         
    breaklines=true,                 
    captionpos=b,                    
    keepspaces=true,                 
    numbers=left,                    
    numbersep=5pt,                  
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,                  
    tabsize=2


style=mystyle




 







left=3cm,right=3cm,top=2cm,bottom=0.5cm



  Radio-Frequency Knockout (RFKO) is a method of resonant slow beam extraction which is able to produce continuous particle spills over durations longer than can be achieved with fast single-turn or non-resonant multi-turn extraction. By using transverse excitation to gradually drive the circulating particles into resonance, spills can be produced over many thousands of turns, at a low intensity, and with a flat time profile.These spills can be delivered to facilities-such as fixed-target experiments or hadron therapy gantries-which require a continuous, low-intensity particle flux of durations significantly longer than the particle revolution period.

In order to accurately and efficiently simulate this extraction process over a wide range of timescales, new modelling tools and computing platforms must be explored. By utilising optimised computational hardware-such as General Purpose Graphics Processing Units (GPGPUs), and next-generation simulation software (such as Xsuite), computation times for simulations can be reduced by several orders of magnitude while remaining accurate compared to empirical measurements.

This thesis presents the novel implementation and simulation of RFKO slow extraction at the East Area (EA) experimental facility, located at CERN's Proton Synchrotron (PS). The results of the experiments outlined seek to confirm both the accuracy of the simulated frequency response and time structure, and the benefits of GPU-accelerated simulation software. These results will also provide an analysis of optimal parameter selections for both the extraction control system-optimising for spill quality-and the simulation system architecture-optimising for performance.


Beam Physics, Computational Physics, Slow Extraction, Radio-Frequency Knockout, Simulation, Xsuite




Introduction

The CERN Proton Synchrotron (PS), alongside providing intermediary acceleration for hadron and ion beams for the Super Proton Synchrotron (SPS) and eventually the Large Hadron Collider (LHC), provides beams for the many fixed target experiments located at the East Area (EA) experimental facility. This facility, as illustrated in fig:eadiagram, consists of the proton (IRRAD) and mixed-field (CHARM) irradiation facilities, via a dedicated 24GeV/c beamline, in addition to a multi-target beamline providing three secondary beams.

Ongoing experiments in these facilities such as the CHARM High-energy Ions for Micro Electronics Reliability Assurance (CHIMERA)  use high-Z ions (Pb) to simulate the harsh radiation environment of cosmic rays which satellites experience. Using low-intensity (<e6ions/spill), high-energy (>100/ u) beams, customers such as the European Space Agency can assess the reliability of new materials in these environments. fig:chain illustrates the two injection chains of the PS, either with Lead ions sourced from the Linear Accelerator 3 (Linac3) and Low Energy Ion Ring (LEIR) chain, or protons from the Linac4 and the Proton Synchrotron Booster (PSB).


      [Layout of the CERN East Area beamlines]Layout diagram of the CERN East Area (EA) beamlines, their proton momenta, and experiments.

      [Layout of the primary injectors and accelerators of the CERN complex]Layout diagram of the primary injection chain at CERN. Particles are sourced from either Linac 3 (for Lead ions) or Linac 4 (for Protons), and accelerated through the LEIR or PSB respectively. After injection and acceleration in the PS, beams are extracted either to the SPS or East Area (EA). Particles at the SPS are either extracted at two LHC extraction locations, or towards the North area. Red diamonds indicate Fast extraction locations, and blue indicate mark Slow extraction regions. Grey triangles indicate injection regions.
Motivation
The CHIMERA experiment, and other experiments located at the East Area and its higher-energy sister site at the SPS North Area, are referred to as fixed-target experiments. These experiments require a semi-continuous flux of particles at lower intensities than produced by the PS. For example, if the entire beam of the PS was delivered to a material sample in an effectively instantaneous "spill" (a controlled removal of particles from the circular accelerator), any sensitive acquisition equipment would become saturated, and the fixed target itself likely destroyed.

At a beam momentum of 5.4 in the PS, the revolution frequency of the beam is around 470kHz. Therefore, delivering particles over the period of one turn could, at most, provide a spill time on the order of 2. This extraction method, known as fast extraction, is commonly used to transfer particles between successive accelerators where the bunched time-structure of the beam is preserved. To provide spills on the order of 100 required for these experiments, much longer than the revolution period, a "slow" extraction system is employed.

Extraction Methods

To move particles between consecutive machines along the primary CERN injector chain, the PSB, PS, and SPS are equipped with fast extraction systems. The principles of these processes will be fully explored in the next section, but a general overview and understanding of its benefits and disadvantages help in understanding the motivation for the use of slow extraction.

As previously mentioned, fast extraction provides a spill of particles typically over the duration of one turn. A fast magnet, at a suitable location in the machine, imparts a large deflective angle to the beam. This ejects the beam from the nominal orbit, where it encounters a second magnet-called a septum-to deflect the beam into a transfer line. The opposite effect is then used to inject the bunch into the next machine: a magnet "kicks" the particles onto the circulating beam trajectory.


      Schematic of the general principle of single-turn fast extraction .
This method of single-turn fast extraction ( fig:fast_diagram) is used at two locations in the SPS-Long Straight Sections (LSS) 4 and 6-to fill the two counter-rotating rings in the LHC . The PSB uses the same method, but has the added complexity of "merging" four seperate stacked rings to one transfer line . LEIR likewise performs fast extraction . The general layout of these systems are shown in , where red diamonds indicate fast extraction locations. Fast extraction systems are also used at the beam dump facilities at various stages of the accelerator chain to discard the circulating beam at the SPS and LHC.

In accelerator-to-accelerator contexts, the synchronous nature of fast extraction allows particles to remain bunched. Multi-turn fast extraction extends this benefit, and is performed when filling the SPS for its fixed-target experiments (North Area) from the PS. As the SPS (6.9km) is approximately 11 times longer in circumference than the PS(The PS is 100 meters across, and therefore m) (628m), the entire SPS can be filled by 11 successive extractions of the full PS. This method, known as continuous transfer (CT), introduces the concept of "shaving" the beam with an electrostatic septum . Previously implemented in extraction from the PS, the beam orbit was bumped similarly to single-turn fast extraction, but was instead forced over the blade of an electrostatic septum (ES), such that a segment the beam is 'sliced' off, kicked towards a magnetic septum (MS), and extracted. The remaining beam is then kicked back onto its orbit. After the next turn, the beam has been "rotated" by a quarter turn, and the process repeats, until finally the remaining core of the beam is bumped directly to the magnetic septum. This provides a spill to the SPS of five bunches over five beam rotations from a single PS bunch.


      Diagram of a general multi-turn fast extraction system .
This method of increasing the spill time is, however, limited by the width of the septum blades. As the amount of beam scraped off per turn decreases, the effect of the particles lost on the septum blade increases. To maintain a reasonable extraction efficiency, the beam size would have to become exponentially large. For example, if a 50% extraction efficiency is desired over  turns, the beam thickness sliced off by the Electrostatic Septum (ES) must be the same as the thickness of the blade itself. For the SPS, the ES has an effective blade thickness of 500 . The required diameter of the beam, therefore, would be  10 . This diameter would be larger than the beam pipes, and clearly physically impossible.

In order to provide spills over a longer duration, over many thousands of turns, slow extraction must be used. 

Introduction to Slow Extraction

Slow extraction instead relies on exploiting resonance of the beam as it oscillates around the orbit of the machine. A full theoretical description of these effects will be detailed in chap:theory, but a brief explanation is offered here: the oscillatory motion of a beam can be controlled such that it returns to the same point along the accelerators circumference with the same oscillation phase, in order to be in harmonic resonance with the periodic field distribution of the ring. Great care is usually taken to avoid this effect in particle accelerators. However, with the correct configuration, this amplitude growth can be used alongside an ES to separate particles from their orbit, towards an MS, and into the extraction transfer line. Should the effect be slow enough, a small fraction of particles will reach the MS per turns.

The exploitation of resonance to induce extraction is by no means novel; a method akin to slow extraction was first proposed by J. Tuck and L. Teng in 1951 , and performed by Le Couteur at the Liverpool cyclotron in 1954 . Many such applications of slow extraction exist, using different effects to drive particles into resonance. This thesis will present some of these methods, particularly focussing on Radio-Frequency Knockout slow extraction.

Many medical synchrotrons, such as the MedAustron Synchrotron, use slow extraction to deliver beam to patients for ion beam cancer therapy , producing spills of up to 30(Limited to 10 for patient treatment). In human medical applications, safety is paramount. Therefore, the slow extraction process must be fully understood. Ripples in the intensity of beam have to be carefully controlled in order to provide a steady, predictable irradiation dose to patients.

Small medical synchrotrons are simpler(The PS contains 100 bending magnets along its circumference, as opposed to MedAustron's 16), newer(The PS began operation in 1959, and is CERN's oldest accelerator still in operation. MedAustron was first certified in 2016.), and have a far higher operational availability requirement than research accelerators such as the PS. At CERN's PS, however, that benefit cannot be relied upon. Machine time is in high demand, and studies are time-shared between machine development (MD), fixed-target experimental areas, LHC physics injection, and a wide array of other facilities. 

Simulations can therefore provide an important tool in understanding slow extraction spills. New methods can be rapidly developed and tested without requiring extensive (and expensive) machine studies, and wide parameter spaces can be explored to construct functional relationships between input parameters and spill output characteristics. 

Modelling Slow Extraction
sec:matrix will introduce a mathematical model which can be used to numerically calculate particle trajectories in simple machines. However, with even the simplest of accelerators at CERN containing hundreds of components, computational models quickly become necessary. In addition, slow extraction can operate over many more accelerator turns than other processes, such as fast single-turn injection. In the PS, a spill length of 0.5 would require approximate 230,000 turns. For even a reasonably powerful machine, these computational simulations quickly become time-consuming. 

To aid with the design and construction of CERN's Large Electron-Positron collider (LEP, the predecessor to LHC), the Methodical Accelerator Design Program (MAD)  was developed. This FORTRAN-based scripting tool allowed physicists to define the arrangement and strengths of magnetic elements around an accelerator (the lattice), define beam parameters, and calculate the resulting motion of particles (the optics). MAD, and its latest version, MAD-X, quickly became the de facto standard within CERN's beam physics community. However, in the twenty years since the release of MAD-X, the landscape of computational accelerator physics has become awash with a wide array of tools, codes, and standards, each with their own specialisations. 

Newer tools are introducing improvements such as "ready-to-go" compatibility with General-Purpose Graphical Processing Unit (GPGPU) acceleration. GPUs are specialised hardware capable of performing highly optimised matrix and vector calculations. This makes them ideal for the matrix calculations required for particle accelerator simulations. Additionally, embarassingly parallel(A problem which requires minimal to no effort to be separated into a large number of independent, concurrently-processed tasks.) tasks can be run on a large number of smaller processing platforms, rather than a single large platform. These platforms could be processing units within a GPGPU, or a discrete computer host on a batch-processing network.

Accelerator Physics Theory
To construct accurate simulations of slow extraction methods, one must first understand the fundamental theory behind particle motion in a circular accelerator. This chapter will introduce the theory required to understand the motion of particles as they travel through an accelerator, and how such oscillatory motion can be exploited to perform slow extraction .
Transverse Beam Dynamics
Coordinate System

The coordinate systems used to describe the dynamic motion of particles in an accelerator such as the PS relies on the periodic nature of a circular accelerator. Using a traditional Cartesian coordinate system would quickly introduce complications when describing circular trajectories, and so a local curvilinear coordinate system is used .

The basis vectors for this system, , rotate in space as the reference particle moves along the accelerator. The longitudinal vector  is tangent to the reference particle's trajectory, and the  direction is parallel to the radius of the accelerator.  This system is shown in Figure , along with the radius of the circular trajectory , and the angle from the origin . 


      [Local coordinate system]The vectors used to define the Frenet-Serret coordinate system.
This coordinate system is known as a Frenet-Serret coordinate system, and can be rigorously defined by the unit vector tangent to the curve  (pointing in the direction of motion), the unit vector normal to the tangent and on the tangential plane , and the binormal unit vector , the cross product of  and . These unit vectors, forming an orthonormal basis spanning  are equal to the vectors  by:


The coordinate system  relies on the right-hand chirality (Figure ) of the vector cross product for the  vector to point radially outwards from the centre of the machine, the  vector points upwards, and the  vector points in the direction of motion.


      [The right-hand rule]The right-hand chirality rule defining the direction of 
Special Relativity

The equations of motion in this thesis consider particles moving at extremely high velocity, approaching the speed of light . At CERN, before injection into the PS, particles are accelerated to 2, and reach 94.8% of the speed of light. At such speeds, relativistic effects are significant.

The Lorentz factor  is defined as the derivative of coordinate time  in the relativistic particle's reference frame, with respect to the proper or lab time  in the observer's reference frame. It is calculated as:

Also defined is the factor 

and the factor 


These factors will be referred to as  to distinguish them from other parameters using  (subsec:trans_phase_space).

One important distinction in a relativistic reference frame is the invariant mass  versus the relativistic mass . The invariant mass, or rest mass of any object is the Newtonian mass measured in its own reference frame. From the lab reference frame, this mass is measured as the relativistic mass, defined as:

This relativistic mass is conserved just the same as rest mass, and follows the  formula as in the rest frame. 
The rest energy  and momentum  are likewise defined in the relativistic frame:


For brevity, this report will always assume a relativistic frame, and all mentions of mass , momentum , or energy  should be assumed to be relativistic unless otherwise stated.

Particle Variables

Following the basis vectors defining the coordinate system, the following variables are used to characterise the orbit of particles, dependent on :

In the transverse planes:

   [m] - the particle's horizontal position with respect to the reference orbit.
   [m] - the particle's vertical position with respect to the reference orbit.
   [rad] - the particle's horizontal angle with respect to the reference orbit.
   [rad] - the particle's vertical angle with respect to the reference orbit.
In the longitudinal plane:

     - the particle's longitudinal position with respect to the reference particle .
     - the particle's momentum difference with respect to the reference particle .
    
    
 

These variables provide 6 vectors fully describing the position of a particle. However, for the remainder of this thesis, the pair of longitudinal variables  will be treated separately to the transverse variable pairs  and . This enables a simpler understanding of the effects of beam bending and focussing magnets, as these effects are independent of the longitudinal variables.

Design Orbit and Dipoles

An understanding of particle dynamics in an accelerator can be built upon the Lorentz force, describing the force  acting on a charged particle with charge  as it moves through an electric field  and magnetic field  with velocity , given as

This equation can already show why magnetic fields are typically used to bend particles along a circular trajectory and not electric fields; a particle with higher velocity  will experience a greater force from a constant magnetic field , whereas the contribution from the electric field  will not benefit from the increasing velocity of a particle.

The other force experienced by a particle in an accelerator is a consequence of conservation of momentum:
 where  is the particle's rest mass, and  is the radius of the particle's orbit inside the accelerator.

Equating equations  and  yields

The quantity  is known as the magnetic rigidity of a beam, and defines the bending angle of a particle for a given magnetic field. 

If the relativistic momentum  of the particle is measured in [per-mode = symbol]amu (atomic mass unit), the magnetic rigidity can be expressed in Tesla-meters:
 
Referring again to eq:lorentz (with the help of fig:rhr), a magnetic field pointed vertically upwards (along the  vector) will cause a positively-charged particle with motion along the  vector to experience a bending force along the  direction (illustrated in fig:dipole). This formulation, however, only considers a single dipole. In reality, the bending magnet structure of accelerators typically consist of multiple dipoles placed around the ring, their power converters connecting in series. The arrangements of these bending magnets-referred to as Main Units (MU) in the context of the PS-will define the reference(Sometimes referred to as design orbit) orbit in the accelerator.


      [Illustration of the force experienced by a charged particle in a magnetic dipole field.]A "front-on" view of a dipole magnet, showing its magnetic field pointing down, and the Lorentz force experienced by a positively charged particle travelling into the page.
If  is the bending angle of a single MU, then  can be related to the magnetic rigidity by

Integrating this over all magnets in the ring, therefore, must be equal to one full revolution, . This provides one of the first key insights which is not obvious at first-that "circular" accelerators are in fact more complex shapes, with bending magnets at each vertex, and a drift (accelerator sections without any significant electromagnetic field) or other non-bending multipole magnet at each side: in the case of the LHC, 1,232 dipole magnets are used to keep the beam on it's circular path; in the PS-100.

Focussing and Multipoles

While single-pair dipole magnets are used to bend the beam along the circular path, double-pair quadrupole magnets are used to bound the transverse motion, and to prevent the beam from spreading (increasing in size) due to the intrinsic spread of position and angle. An arrangement of four magnetic poles creates a field stronger at higher  displacement, causing particles to be pulled back towards the design orbit, "focussing" the beam in one transverse plane (while necessarily defocussing in the other). To correct for the defocussing in the other plane, a second quadrupole is placed further along in the beamline, with the magnetic poles arranged in the opposite orientation. This arrangement, known as a FODO lattice, is shown in fig:quadrupole (right). fig:sextupole depicts a sextupole magnet, with three pole pairs, which is used to correct for the dispersion effect of a dipole.


    [Diagrams of a quadrupole magnetic field, and a FODO cell]Diagram (left) showing the field of a normal oriented quadrupole, providing focussing in  but defocussing in . The force experienced by a positively-charged particle is shown as dashed arrows. Right-hand diagram illustrates a FODO cell, where the structure of repeting focussing and defocussing quadrupoles can be related to the optical analogy of lenses.

            [Diagram of a sextupole magnetic field]A diagram showing the field of a normal oriented sextupole. The force experienced by a positively-charged particle is shown as dashed arrows.
Single-Particle Oscillatory Motion

In a periodic (circular) accelerator, the linear equation for transverse motion takes the form of a differential equation:
 
where  is the normalised quadrupole coefficient, defined as

The periodicity of circular accelerators requires that  is also periodic, and the same gradient is seen after one turn. The  term represents the effect of the dipole bending field, providing a weak focussing effect. If we enforce the periodicity(i.e. that the quadrupoles do not change between consecutive revolutions) in  of , Equation  can be rewritten in a compact form
 where the quadrupole focussing component  is now a function of . With the given periodic boundary condition ,  is known as the Hill's equation. 
Following Floquet's theorem , the general solution to this equation takes the form of
 
where  is the oscillation phase,  is the initial condition, and  is an integration constant.  and  are constants of a trajectory, and so the transverse oscillation of a particle is given by the special  function. The  function must also satisfy the periodic constraint , and is related to the  phase function by the following equation:


Taking the derivative of eq:motion_x with respect to  gives an equation for the angle of the trajectory:


The overall phase advance of transverse oscillations over one revolution of  is known as the betatron tune of the accelerator, and is defined as

This quantity, often simply referred to as tune, effectively indicates how many complete transverse oscillations a particle makes in one turn. The fractional part of this value is the most significant, and the integer part of a referenced tune may sometimes be omitted.

Particles with momentum different to the reference particle  will experience different focussing effects in quadrupoles. This slight change in focussing will effect the oscillatory motion of off-momentum particles, and result in a spread of tunes throughout a distribution of particles. The variation of this tune, with respect to the variation in momentum, is characterised by the normalised chromaticity (where it is divided by ), variously defined as  or :


Phase Space
eq:motion_x and eq:motion_px introduced an integration constant , which is a characteristic parameter of the particle or ensemble of particles. It is known as (transverse) emittance, and is usually considered with particle ensembles in mind. These two equations can be manipulated to provide an expression for :
 where 
 and

These two values, along with , form the Courant-Snyder Parameters , commonly referred to as the twiss parameters(Even Richard Q. Twiss, a British astronomer, was himself unsure as to how the parameters became attributed to him .). 

These parameters can be readily understood in the phase space of . Illustrated in fig:twiss-phase-space, eq:emittance describes an ellipse, which covers the area of the particle ensemble in phase space, the area of which is given by . 


      A phase-space ellipse in  and its relation to the Twiss parameters.
  
Liouville's theorem states that, under conservative forces and at fixed energy, this emittance is conserved(Normalised emittance is conserved during acceleration where energy is not fixed), and no external field can change it. Hence, eq:motion_x provides it as an invariant of motion. 

Dispersion
We now consider the oscillatory motion of multiple multi-energetic beams, with reference to the ideal particle. This ideal particle, with reference momentum  and initial conditions all equating to zero, has a path through the field centre of all quadrupoles, and so experiences no quadrupole effect . This means that its motion is controlled by the weak dipole focussing . A nominal particle, still with momentum  but with initial displacement and/or angle conditions, will perform closed-loop betatron oscillations around this path. 

A particle with a momentum offset, , will still satisfy  from before, but in the inhomogeneous form

We can use the homogeneous solution previously found to form the complete solution . This inhomogeneous term , is normalised by the momentum difference to produce the Dispersion function
 describing how the additional amplitude of an off-momentum particle depends on the momentum difference. 
This dispersion function satisfies, for the circumference of the machine:


Matrix Formalism
eq:motion_x and eq:motion_px can be solved by imposing initial conditions  and  instead of periodic boundary conditions:


where  now combines the quadrupole focussing effect  (eq:quadrupole) and the dipole weak focussing effect:


These two equations can be written as a matrix equation:

where  is the transfer matrix


The definition of this transfer matrix  can be expanded to define the variety of magnets used in an accelerator. In the simple case, where no magnet is present, we define the transfer matrix for a drift space of length :


For a normal dipole magnet bending only horizontally, where  and , the transfer matrix is:



Further matrix equations can be defined for other magnets. If we define the properties of each element in the accelerator (the lattice), we can then define the transfer matrix for the entire accelerator as the product of the transfer matrices of each element. For example, a FODO lattice with an initial bending dipole can be defined as:


This is the principle by which particle tracking codes, such as MAD-X, operate. An input lattice file defines the structure and properties of the magnets composing the accelerator, and particle variables are then computed with matrix multiplication. 

Expanding on the idea of matrix formalism and the phase-space ellipse, many particle tracking codes operate in normalised phase space -that is, where the phase space of  is linearly transformed in a way which results in the phase-space ellipse becoming circular. The matrix transformation is therefore defined as


Longitudinal Dynamics
Where the transverse planes principally consider bending and focussing effects from magnetic fields, the longitudinal plane considers acceleration effects from RF fields. Returning again to eq:lorentz, we instead now consider the electric component:
 
An electric field of magnitude  travelling in the  direction can be defined as
 where  is the RF frequency. Therefore, for a synchronous particle with synchronous phase , the rate of energy gain is


In a synchrotron, where the orbit of particles is of constant radius, the magnetic field  needs to increase in time (ramp) as the particle is accelerated. Additionally, to keep the particle in phase with the RF cavity, the frequency of the RF  must follow the particle's energy gain. This synchronous condition, for velocities , is defined as
 where  is the synchronous particle velocity and  is the RF harmonic, the number of RF cycles per revolution. For East Area beams in the PS,  acceleration is used. This means that there are eight stable "particles", spread equidistantly around the ring circumference. 

To keep a particle with increasing energy bent along a path of constant radius, the magnetic field  of the bending dipoles must increase as RF acceleration occurs. Recalling eq:brho, and deriving by time, obtains

For one turn in a synchrotron, this results in a momentum gain
 where  is the machine length. 
The energy gain  per revolution is therefore
 where  is the synchronous phase. This stable phase therefore changes while energy is ramped:


Dispersion

Next, akin to sec:transdisp, we consider small perturbations in momentum with respect to an ideal path. We define two parameters:
 where , the momentum compaction factor, is distinct from the relativistic  and Twiss parameter .
 where , the slip factor, is the relative change of revolution frequency with momentum.

Using the dispersion function eq:dispersion, we can relate the momentum compaction factor to its effect on orbit length  

Using the revolution frequency(NB:  here refers to the relativistic Lorentz factor  ) , we define the relative revolution frequency change  as
 



This defines a transition energy  such that , causing no change in revolution frequency  for a small momentum change :

Above this transition energy, where , the particle has velocity , and so the path-length change dominates the velocity change. This is the standard configuration of accelerators.
Below this transition energy, where , the increase of velocity is significantly larger than the path-length change effect.
At this transition energy, both effects compensate, and so  becomes independent of . Here, the synchrotron longitudinal oscillations stop, and particles not on the synchronous phase  will rapidly gain energy, and become lost due to dispersion .


Longitudinal Phase Space
These effects can be analysed by considering phase-space coordinates-this time in the longitudinal plane. This space is constructed with variables , and shown in fig:long_phase_space. A full derivation for the longitudinal motion invariants can be found in , where the synchronous phase  defines the orbit with zero longitudinal (synchrotron) oscillation. Outside of the stable envelope, demarcated by the separatrix, particles are lost to instability. The region within the separatrix is known as the RF bucket, and the area occupied by stable particles, the RF emittance.


      [Longitudinal phase space and particle stability]Longitudinal phase space, showing particles at the synchronous phase , inside stability, and in unstable motion. The separatrix, bold, separates these two regions.
Slow ExtractionNow that the fundamentals of accelerator beam physics are established, this section will introduce the principles behind slow extraction (SX). Various methods of performing SX will be covered, but the particular method covered in this thesis-Radio-Frequency Knockout (RFKO)-will be described in detail.

Sextupoles and -Integer Resonance

sec:transdisp introduced the concept of dispersion in reference to a multi-energetic beam. These effects are controlled with the use of sextupole magnets. The transverse field of a sextupole magnet has the form

 where


In normalised coordinates (eq:normalised), these effect of these fields (in a thin-lens approximation) becomes
*
where , the normalised sextupole strength, is
 where  is the sextupole equivalent length, and  is the normalised sexutpole field:

For extraction driven in the horizontal transverse plane, the dynamics of the vertical transverse plane are neglected as these remain independent. Recalling the matrix formalism established in sec:matrix, we use a general transfer matrix for  turns with a betatron tune :

The tune of a particle is then defined as a third-integer, i.e.
 
The tune distance, , is therefore the distance of the particle from the resonance. The -turn matrix can then be approximated for modulo-3 turns:



Therefore, a particle with , i.e. exactly on resonance, will return to its original position after three turns. For such a particle, the change in position  and divergence  from initial conditions  after three turns is therefore calculated as


where , the modified tune distance, is defined as , and  is the normalised sextupole strength (eq:normalised_sextupole_strength).

The values of  and  are known as the spiral step and spiral kick.
The Hamiltonian is now used to analyse this motion in phase-space. The Hamiltonian,  is a time-independent constant of motion, the contours of which describe the phase-space map, the motion of a particle in normalised phase-space. Assuming the 3-turn time is small enough to be continuous, the Kobayashi Hamiltonian  is defined as



      [Phase-space map of the Kobayashi Hamiltonian]Normalised phase-space map of the Kobayashi Hamiltonian, for a ratio . The points  are shown, with connecting lines.
The first term describes the typical circular phase-space motion familiar from subsec:trans_phase_space, with a sextupole strength  (i.e. a linear machine). The second term describes the sextupole effect, transforming the elliptical map into a triangular trajectory for increasing values of  and . The phase-space map is shown in fig:kobayashi. A boundary triangle is easily identified from the map, which defines the trajectory of the stable particle with greatest possible amplitude, before the motion becomes unstable. Outside of this stable region, the particle trajectories do not close on themselves, and the particle will rapidly gain amplitude. The region bounded by this separatrix is known as the acceptance the size of which is defined by , and can be found by factorising  at at a value of , which factorisses to three points:

The  location of the stable particle,  can also be defined as

Therefore, the lines connecting  and  (solid lines in fig:kobayashi), along with the vertical line at  (dashed line in fig:kobayashi), define the separatrix. The acceptance, the area bounded by the separatrices, is defined as .

Slow Extraction Principles
The fundamental principle of slow extraction exploits the unstable boundary created by sextupolar fields. After a beam is injected and stable, this waiting beam is accelerated towards the -integer resonance. A particle at resonance will then "lock on" to one of the separatrix arms, and its amplitude will grow in steps of three turns, rotating around the three separatrices. By carefully controlling the rate at which particles enter resonance, the 3-turn amplitude growth (spiral step) can be adjusted to create a desired flux of particles entering resonance. After a number of turns of amplitude growth (typically hundreds), an electrostatic septum located at some distance from the waiting beam will provide a kick necessary to extract the particles. A real-world diagram of slow extraction is shown in fig:real-world.


      [Real-space diagram of momentum-driven slow extraction]A real-space diagram of momentum-driven slow extraction, looking along the  direction at the magnetic septum location. The waiting beam approaches resonance (dashed), and some particles begin large turn-by-turn oscillations (increasing shaded gradient with turn number) before they jump the septum blade (thick black line) and will be extracted.
There are a variety of methods to provide acceleration of the beam towards resonance, which fall into two categories. Momentum-driven methods rely on accelerating the beam towards a stationary resonance by controlling the momentum . Amplitude-driven methods, however, use transverse noise or RF excitation at the beam's revolution frequency to create increasing betatron amplitudes. 

Other methods involve moving the resonance itself, by changing the tune of the machine. This can be accomplished by using dipoles, quadrupoles, or sextupoles, but is susceptible to complications arising from the changing transverse optics. Implementations would require active compensation to maintain the beam's position, size, and ultimately, stability.

These various categories are not mutually exclusive, and some of the methods discussed will use a combination of effects to achieve slow extraction.

Steinbach Diagram

      [Steinbach diagram of momentum-driven slow extraction]Steinbach diagram of momentum-driven slow extraction. Waiting beam in black, resonance driving effect in red, unstable beam in grey.

      [Steinbach diagram of amplitude-driven slow extraction]Steinbach diagram of amplitude-driven slow extraction. Waiting beam in black, resonance driving effect in red, unstable beam in grey.
The two beam-moving methods of momentum and amplitude-driven slow extraction can be compared using a Steinbach(Attributed to C. Steinbach, CERN) diagram. This plots the beam amplitude  as a function of momentum . The sextupole instability is shown as a triangle, within which is the unstable region beyond the phase-space map separatrices. fig:momentum-driven and fig:amplitude-driven illustrate momentum and amplitude driven slow extraction respectively.
In order for a particle to be considered stable, its single-particle emittance  must be lower or equal to the area of the separatrix triangle. Using eq:apothem, this condition is expressed as
 
If this condition is plotted on a  graph, the stable triangle shown in fig:momentum-driven and fig:amplitude-driven is seen. The width of this unstable triangle, known as the stopband, is proportional to .

Slow Extraction Techniques
A variety of slow extraction implementations can be found across particle accelerators. While all will vary to some degree, most can be categorised by which parameter is used to control extraction, and which equipment or magnet is employed. For example:

  The National Center for Oncological Hadrontherapy (CNAO) uses Betatron Core slow extraction : a circular magnet produces a longitudinal acceleration, driving particles into 1/3rd-integer resonance.
  The MedAustron facility has also used Constant Optics Slow Extraction (COSE) , simultaneously scaling the magnetic strength of bending dipoles, and sweeping the betatron tune. This method allows for the alignment of separatrices at different momenta, improving the spill quality.
  Phase Displacement Extraction (PDE) allows for resonant extraction without the need for ramping magnetic elements. This avoids pertubations or ramp-rate limits which could arise, and has been tested at both the PS and MedAustron .
  The Xi’an Proton Application Facility (XiPAF) uses Radio-Frequency Knock Out (RFKO) extraction , an amplitude-driven method which transversely "heats" (excites) the beam, increasing emittance and amplitude into unstable regions.
These accelerators and extraction techniques are mentioned for illustrative purposes: it is not an exhaustive list, and most accelerators can employ multiple methods.
 
The work in this thesis will focus on implementing (and later, simulating) Radio-Frequency Knock Out (RFKO) for East Area extraction at CERN. A variety of reasons motivate this: RFKO can be performed with both bunched (particles are longitudinally trapped by RF cavities) and coasting (debunched, particles spread along the entire ring circumference) beams. Performing bunched RFKO allows for the same beam to be re-accelerated and re-extracted multiple times . Additionally, this method is typically quicker to respond (i.e. turning on and off extraction) than other methods .

RFKO can also be used with an amplitude modulated (AM) excitation, which can be calibrated to provide a constant particle flux over time. However, for the experimental application in this thesis, AM was not used, as the extraction process took place over a long enough time period where flux was not a concern.

The principle of RFKO, as illustrated in fig:rfko_phase_space, is to excite particles into the resonant instability region by providing transverse "heating" of the beam-using a radio-frequency exciter to provide a small transverse kick to the beam, increasing its amplitude. A variety of different signals can be used to drive the excitation: theoretically, white noise (a random signal with equal intensity at all frequencies) would be the ideal signal, providing a purely diffusive effect in phase space. However, pre-existing hardware favours the use of a frequency-modulated "chirp" signal, centred at the third-integer fraction of the betatron tune. A range of frequencies around this value is required as there is a range of momenta-and thus a range of tunes-present in the PS East Area beams. 


      [Phase-space schematic of RFKO slow extraction]A phase-space schematic of RFKO, showing the emittance growth (dashed to solid ellipse) increasing the amplitude of a stable particle (white) into the unstable region (grey), where it moves along the separatrices (arrows) into extraction.
Implementation and Simulation

This chapter presents the novel implementation of RFKO slow extraction at the PS, providing a spill to the East Area fixed-target experiments. As motivated in sec:modelling-slow-extraction, this chapter will also outline the development of simulation models for the RFKO system using existing particle tracking and accelerator optics software. Significant effort was made to streamline the simulation process, leverage the GPU acceleration available in Xsuite, and to make full use of the computing platforms available at CERN.

RFKO Slow Extraction at the CERN PS

For the implementation of RFKO extraction to the East Area, a basic EA-type beam was set up and configured as follows. For preliminary studies, a [per-mode=symbol]750 cnucleon Lead (Pb^+54) ion beam was used, produced by Linac 3 and injected from LEIR. This is the beam configuration used by the CHIMERA experiment, as it provides the correct energy, flux, and beam size for its requirements. After these tests, when an ion beam was no longer available, a proton beam with equivalent magnetic rigidity was used.

This equivalency can be calculated using eq:brho, eq:relativistic_energy, and eq:relativistic_momentum, producing an equation for the total momentum of an ion beam:
 where  is the rest mass of the ion, and the relativistic gamma factor .

A (Pb^+54) ion ( protons,  neutrons,  electrons) at kinetic energy [per-mode=symbol]750nucleon will have an atomic mass  of 208, and so a kinetic energy of 









and a rest mass of 193.74. The equivalent proton momentum, using eq:ion_momentum and eq:brho, is then calculated as 5.397. 

Therefore, a single-bunch, low intensity ([per-mode=symbol]30d10particlesbunch) 5.397 proton beam was chosen, injected to the PS through a single PSB ring (ring 3). The cycle was configured to use two basic beam-cycle periods of 1.2, in order to extend the window available for a spill to 500.


      [Schematic of the PS Ring and East extraction system configured for RFKO slow extraction]A schematic of the PS Ring and East extraction system, as configured for RFKO slow extraction. All important beamline elements are labelled with their CERN layout code. Also shown is the reference orbit (solid line), the bumped orbit (dashed line) created by the kicker magnets, and the extracted trajectory (double line) created by the magnetic septa.
Closed Orbit and Extraction Trajectory

As shown in fig:schematic, the closed orbit of the PS at extraction differs to that of the nominal orbit. Four bump magnets, (BSW) create a large horizontal displacement at the two septa SMH57 and SMH61. This brings the closed orbit within range of the septum blades, where resonant particles can then cross the blade and enter the septum window.

The electrostatic septum, placed before the magnetic septa, is not used in this study, as it is skipped by the beam during ion extraction. It was decided that a proton implementation closer to the ion configuration would be advantageous, so that results can be compared to work carried out by CHIMERA.

Cycle Parameters
The dipole magnetic field required for a [per-mode=symbol]5.392 c proton beam is 0.257, which provides the configuration for the PS Main Unit being magnets. In order to control the third-order resonance, and align the separatrices with the septum blade, the extraction sextupole system was enabled. This consists of a high-level parameter PR.XSE/K, which controls the sextupole normalised strength  of the two extraction sextupoles, XSE01 and XSE07 (fig:schematic). 

A high-level parameter QSE is also provided, which controls the normalised strength  for a set of extraction quadrupoles (fig:schematic). These serve to aid in betatron tune  control, and to increase the amplitude  while decreasing the dispersion  at the septa locations. This large  allows the septum to be placed further from the circulating beam, and the small dispersion  aligns the separatrices at different momenta along the septum blade. These two parameters QSE and XSE, have been pre-configured for nominal East Area slow extraction.

The high-level tune control knobs were also configured for RFKO. These use the Pole Face Winding (PFW) magnets present in every PS Main Unit dipole to control the horizontal and vertical betatron tunes  and chromaticities . Tune control was very important to the set-up of this implementation-the horizontal tune was positioned close to the third-order resonance, at 0.32. The chromaticity was minimised to avoid part of the circulating beam being brought into resonance before the RFKO system was activated, which would cause a low-level initial uncontrolled spill. This tune control is shown in fig:tunemap, which plots vertical tune against horizontal tune. This provides a convenient visualisation of first, second, and third order resonances. These resonances are defined by
 where , , and  are arbitrary integers, where  defines the resonance order. Also used is the fractional tune split, , defined as

From fig:cycle, we find the tune split at injection , and at extraction , both of which avoid coupling resonances.


      [Fractional tune map during RFKO slow extraction]A fractional tune map, plotting the evolution of horizontal fractional tune  against vertical fractional tune  during RFKO slow extraction. Color scale indicates time. Dashed lines indicate some of the first order (red), second order (green) and third order (blue) resonances. Black lines at  are the final tunes reached at the extraction period. Integer part for all tunes is 6.

      [High-level parameter graphs and tune measurements during RFKO slow extraction]The high-level parameter configuration for the implementation of East Area RFKO slow extraction. Top graph shows the bending dipole  field, points of injection (from PSB) and dumping (internal absorption of remaining beam), and regions of acceleration (ramp) and stable period for extraction. Second graph shows multipole components  for extraction quadrupole () and sextupole (). Final graph shows fractional betatron tune measurements for horizontal and vertical plane.
The RF system in the PS (sec:long) is used to accelerate the beam up to 5.392 during the ramp period, and to maintain bunching during flat-top. An East-type beam in the PS is bunched at the 8 harmonic, or can be disabled to debunch the beam (known as a coasting beam). RFKO can be performed with both a bunched and coasting beam, and both scenarios will be examined.

Transverse ExcitationOnce a basic, stable cycle is configured in the PS, the transverse excitation is implemented. This uses a transverse kicker located at section 97 of the PS, KFB97, a 1 long strip-line kicker, with both horizontal and vertical planes . With a peak RF power of 5000 across the two electrodes, and an impedance of 100, the transverse feedback (TFB) kicker can provide a peak voltage at 1000 and current of 10. The electric and magnetic fields are then defined as:


where  is the electrode aperture 70. The electric and magnetic deflection angles are then 
 where  is the electrode length 935. The stripline components  and  both contribute to the kick, and so the summation of these two angles provides a maximum deflection of 10.814605.

To drive this transverse kicker, two systems were used. Initially, the Qmeter control program  provided an interface to this kicker. While the program was designed-and used extensively in this study-for tune measurements, it can be exploited to provide a frequency-modulated chirp signal crossing the 3-order resonance to the TFB plates. The program was used to configure the start and stop frequencies for the frequency-modulated chirp (as unit interval multiples of the revolution frequency ), chirp length (in  revolutions), and the time after which the chirp would repeat (in milliseconds). This produced the effect of a repeated frequency-modulated chirp windowed by a square signal (fig:qmeter-signal). Previous studies  found suitable parameters to produce a baseline RFKO extraction implementation, tabulated in tab:qmeter-params, and found a significant dependency of spill quality on the chirp repetition rate.

[]
    
  [Initial Qmeter parameters]Initial parameters for RFKO extraction using the Qmeter control program.

      [Example chirp signals generated by Qmeter]An example of the chirp signal generated by the Qmeter application; a frequency-modulated chirp windowed by a square signal. Top plot shows the signal (amplitude, black) and frequency modulation (red) in the time-frame of one repetition. Bottom plot shows multiple repetitions over the span of 10 ms.
To explore chirp repetition rates above the 1 (below 1) limit of Qmeter, a new signal generator was configured to control the TFB kicker plates. This function generator was configured as a two-channel source, channel 1 being a sine wave with a frequency modulated by channel 2, a ramp/sawtooth wave. By choosing a central frequency and frequency deviation corresponding to the chirp generated by Qmeter, the function generator was able to produce a similar signal to that of the Qmeter system, but not windowed by a square function (eq:both-chirps). This allowed for chirp repetition rates of 1 and above, and was used to explore the effect of chirp repetition rate on spill quality.


      [Comparison of chirp signals generated by Qmeter and the AFG]An example of the chirp signal generated by Qmeter (top) and by the arbitrary function generator (AFG) (bottom).
To aid in the research in this paper, and future use-cases of RFKO at the PS, a package was written to simplify the interface with the AFG via the Standard Commands for Programmable Instruments (SCPI) protocol. This interface-available as part of the CERN General Devices package -configures the AFG for RFKO extraction, and provides a Python class for modifying the chirp-generation parameters in terms of the revolution frequency , and the chirp length in milliseconds. This package was used to control the AFG for the results presented in this paper.


Modelling RFKO Slow Extraction
As motivated in sec:motivation, the majority of work surrounding the results presented in this thesis was towards developing a simulation framework to accurately model the spill structure of RFKO at the PS. This section will detail the simulation tools used, the implementation of the RFKO extraction simulation, and the methods used to compare the simulation results to machine data.

Simulation Tools

A variety of simulation software packages for accelerator physics are available, each having their own optimisations, and application areas amongst the accelerator physics community. For this study, the MAD-X  and Xsuite  packages were used. MAD-X is a common tool in the area of optics and beam transfer, and CERN provides a common optics repository-acc-models -containing MAD-X sequence files which describe the optics lattices for the CERN accelerator complex. For the PS, many scenarios are provided alongside the operational models, one of which is a pre-configured for East Area slow extraction.

Xsuite-a relatively recent simulation tool, first made available in 2021-is a Python package which shares many similarities with MAD-X, and can import MAD-X sequences into its own lattice definitions. However, Xsuite has additional capabilities, such as context management, which provides the ability to run simulations on different hardware-namely GPUs. This is achieved by using the cupy  package, which provides a drop-in replacement for numpy, but with optimisations for accelerating workloads on GPUs. Additionally, Xsuite has an existing Exciter beam element, which can model the time-dependent transverse kicker used in RFKO. There has been a rapid increase in the use of Xsuite within the accelerator physics community at CERN, which-combined with the additional capabilities beyond MAD-X-motivated its use in this study.

Lattice Configuration 

The East Area Extraction scenario provided by acc-models was used as the basis for all simulation models, and was modified to include the parameters outlined in sec:magcycle. This generated lattice file-defining the strengths and location for all 1326 beam elements-was used to produce the optics plots shown in fig:acc-models-optics, which displays how the kicker magnets create large displacements at the extraction septa, and how dispersion is controlled by the extraction quadrupoles.


      [Closed-orbit optics plots of the PS EA extraction model]Optics plots of the closed orbit for the acc-models PS East Area extraction scenario. Top figure shows horizontal closed orbit , middle figure shows Twiss beta function , and bottom figure shows transverse dispersion . Also labelled are key extraction elements: the magnetic septa (SMH), the extraction quadrupoles (QSE), extraction sextupoles (XSE), and kickers (BSW)
This lattice was then imported to Xsuite, where the custom RFKO beam elements could be included. These elements were:

  An Exciter, modelling the TFB kicker KFB97.
  A LimitRect, modelling the magnetic septum SMH57.
  A Cavity, modelling the RF cavities providing acceleration and longitudinal focusing, operating at the 8 harmonic.

Exciter
Using eq:kick-electric and eq:kick-magnetic, a function (lst:kick_angle) was written to convert the voltage applied across the TFB kicker to the angle of deflection generated by the electric and magnetic fields. This value was then used to define the strength of the Exciter element, which was placed at the location of the TFB kicker in the lattice. Another function (lst:generate_chirp) was written to generate the chirp signal as generated by Qmeter and the AFG. This function was then used to define the Exciter element's samples parameter, which is used to define the time-dependent kick. 

SeptumThe first magnetic septum, SMH57, was modelled as a simple rectangular aperture LimitRect. By setting this aperture to coordinates corresponding to the window of the septum, particles which are lost to the aperture can be considered as extracted. In the real machine, particles recieve two magnetic septum kicks, from SMH57 and SMH61, but this study only considered the first septum to simplify the model and avoid simulating lost particles for longer than necessary. As only one aperture is modelled, it can be assumed that particles lost to an aperture limit-with Xsuite particle state 0 (flag XT_LOST_ON_APERTURE)-entered the window of the septum and were extracted. 

RF Cavity

A single RF cavity was added to the model, corresponding to the RF system of the PS. While the real system comprises of many such cavities, modelling a single cavity with the total RF voltage applied provides an accurate representation of the longitudinal dynamics of the beam, given that there are no other longitudinal elements present in the model.

Distribution Generation

To accurately simulate the conditions used in the RFKO studies, the initial particle distribution must be generated using machine measurements. The parameters used included:

  Beam momentum  []
  Intensity  [proton bunch]
  Horizontal RMS emittance  []
  Longitudinal RMS emittance  []
  

These values were obtained during machine studies. The beam momentum and intensity were fixed values, configured by high-level machine parameters. The horizontal emittance  was measured using Secondary Emission Monitor (SEM) grids , and the longitudinal emittance  using tomography of the beam current profile . The measured values are shown in tab:initial-conditions. The beam distribution was then generated according to these parameters, and "matched" to the model longitudinal dynamics of the model by Xsuite. An example of the generated distribution is shown in fig:initial-dist.

It was decided that the simulation code will generate a new distribution each time it was initiated, rather than loading a pre-generated distribution from a file. This was done to allow for the random distributions to be generated with a different random seed each time, avoiding the same distribution being used for each simulation which could introduce bias in the results. This also allowed for the particle generation parameters to be dynamically adjusted on a per-simulation basis, enabling the testing and optimisation of these parameters. This design choice ensured the simulation code was flexible and could be used for a wide range of studies at different beam energies and intensities.

With a sufficiently large number of particles, these random distributions will be statistically similar. This obviated the need to transfer a large, persistent file to each simulation job; this transfer time was, qualitatively, found to be longer than the time taken to generate a new distribution file of the same size.

[]
    
  [Initial particle generation parameters]Initial parameters for particle generation, corresponding to measurements made during machine studies.

      [Initial particle distributions generated by Xsuite]Examples of initial distributions generated by Xsuite, for number of particles , with parameters as shown in tab:initial-conditions. Also plotted on each are the  emittance ellipses, and the closed orbit particle (red). Top plots show transverse phase-space distribution for all simulation types. Bottom plots show longitudinal phase-space distribution for a bunched (RF system active) beam (left) and debunched (RF inactive) beam (right).
Simulation Process
Once an initial simulation process was built, one issue became immediately apparent: to simulate the full 0.5 extraction region (fig:cycle), the simulation needed to process approximately 235,000 turns. To produce a statistically significant extraction rate, a sufficient number of particles-roughly 500,000-needed to be generated and simulated. A typical desktop computer, for instance, would require over 600 hours to complete such a simulation, at a rate of roughly 13iteration.

To accelerate the simulation speed to a more reasonable rate, two tools were employed. While not unique to Xsuite, they are both simplified by the package. The first method was the simplest: as mentioned previously, Xsuite provides ready-to-go compatibility with CuPy and CUDA GPU acceleration. The second method relies on CERN's Batch Service, a high-throughput computing service which allows users to submit jobs via the HTCondor  framework. 

To submit the simulation jobs to the batch processing service, the simulation software was containerised using a Docker  image. This image provides a complete environment for the simulation, including a distribution of Python, the Xsuite package, the CuPy package, and various other dependencies. 

This image was made available on CERN's image registry using a continuous integration platform, allowing the image to be automatically re-built and re-published when changes are made to the configuration. It was also distributed via the CERN Virtual Machine File System (CVMFS), which HTCondor can use to initialise machines running batch jobs. This container  eliminated the need to set up the simulation environment on each machine, ensured that the simulation were run in a consistent environment, and enabled the use of HTCondor's GPU resources. 

fig:flowchart shows a flowchart describing the simulation process as successfully implemented. While some efficiency could be made by including shared resources (such as the ps.seq lattice file) within the Docker image, developing a general base environment for any Xsuite simulation will prove useful in the wider community, and in work outside of the scope of this thesis. Initial test simulations included a Monitor object to record the turn-by-turn particle parameters of simulations. This is a very computationally expensive and memory-intensive process, and was removed from the final simulation process, but enabed detailed debugging and analysis of the simulation process. One example, fig:phase-space-sim, shows the progression of phase-space particle distribution throughout the first 1000turns of a simulation. Here, the characteristic features of the Kobayashi Hamiltonian phase-space map (fig:kobayashi) can be seen, in addition to the transverse heating (emittance growth, fig:rfko_phase_space) and extraction separatrices as discussed in sec:rfko.


      [Simulated RFKO phase-space distribution at extraction septum]Phase-space distribution of the RFKO simulation at the SMH57 septum location, plotting all particles for the first 1000 turns (approx.2.128 in laboratory time). RFKO driven by a transverse excitation frequency chirp across  at a rep-rate of 0.12. Color scale indicates turn number. Inset shows extracted particle distribution and a spiral step of 6.1.



      A flowchart describing an overview of the simulation process

Analysis and Comparison of Results
This chapter presents the methodology and results of experiments seeking to confirm the successful implementation of RFKO slow extraction at the PS for East Area spills. The accuracy of the simulation models will be confirmed by analysing the spill characteristics, compared between experimental data taken in June 2023 and the results of simulations. This chapter will also seek to demonstrate the benefits of GPU-accelerated particle simulations using Xsuite, as compared to typical CPU workflows.


Computation Time

In order to compare the advantages of GPU acceleration provided by Xsuite, the simulation process described in sec:sim_process was implemented and run using CERN's batch service. The simulations used single-CPU compute nodes, either using Xsuite's CPU context, or GPU context with additional Nvidia GPUs via Xsuite's CUDA interface. Simulations were run for a range of numbers of particles and turns, and the real-time (wall-clock) duration of the simulation was recorded. These results are presented in fig:cpu_graph_per_turn and fig:gpu_graph_per_turn. The number of particles in a simulation--effectively controls the computational intensity, as it determines the number of calculations which must be performed per iteration (turn). The number of turns--controls the number of iterations, and is therefore used to normalise computation time between simulation runs.

These figures show significantly different dependency of simulation process time on the operational intensity between CPU and GPU workloads. For CPU tasks there is no parallelism available, so for -where performance isn't dominated by constant-time overhead processes-performance is dependant on . For GPU tasks, however, there is a significant initial overhead process of allocating and transferring data from the CPU to GPU. This is apparent from the stratification of performance (time per turn) in fig:gpu_graph_per_turn. The performance, however, is not dependent on  for , where the performance is dominated by the constant-time parallelism available.

GPUs employ a Single-Instruction Multiple-Data (SIMD) architecture to execute a single operation on multiple data points (vectors) concurrently. This is in contrast to CPUs, which employ a Single-Instruction Single-Data (SISD) architecture, where each operation is performed on a single data point at a time. This means that the GPU can perform  operations in the same time as a CPU can perform a single operation, and so the performance is not dependant on . The GPU constant-time performance is saturated for , where all available parallelism is being used, and performance is once again dependant on . Previous research has shown similar performance dependency on  for GPU accelerated simulations .

The paralellism-saturated performance of both CPU and GPU simulations can be formulated as linear relationships in log-log, using the equation
 where  and  are some constants of the performance of a particular machine. By fitting the linear domain performance to this equation, values of  and  can be estimated for particular CPU and GPUs. For these benchmark simulations, various AMD Epyc CPUs were assigned to the machines, and NVIDIA A100 40GB GPUs were used. This specific combination of hardware resulted in  for CPU-only simulations, and  for GPU simulations (fig:cpu_graph_per_turn, fig:gpu_graph_per_turn).

)
      [CPU-bound simulation time performance]Real simulation time (s) per turn for CPU workload per turn as a function of number of particles. Line color indicates number of turns simulated.)

      [GPU-accelerated simulation time performance]Real simulation time (s) per turn for GPU workload per turn as a function of number of particles. Line color indicates number of turns simulated.)

      [Comparison of simulation time performance between CPU and GPU workloads]Real (wall time)) simulation time (s) per turn for CPU workload divided by GPU workload for the same , showing the relative performance increase of GPU acceleration. All other parameters (e.g. number of compute cores) are held constant.
These optimisation improvements make a clear justification for the use of GPU-accelerated workflows. fig:comparison_graph_per_turn shows the relative performance increase of GPU acceleration over CPU-only simulations, for the same . In the best case, with , the GPU-accelerated simulation can be  times faster than the CPU-only simulation. At more reasonable , GPU simulations are still several orders of magnitudes faster than a CPU, and only slower at .

Previous work on optimising simulations slow extraction (at the SPS) achieved a simulation time of 7 hours 30 minutes (27000) for a total of 200000turns and 1000particles , using a similar batching process, but without the advantage of GPU acceleration. The simulation process described in sec:sim_process achieved a total time of 13 minutes (779.8) for the same number of particles and turns running on a GPU platform. This represents a  speed improvement.

These findings motivated the selection of parameters for later simulations. To simulate the full 500 extraction period requires 235000turns to be simulated. At this number of turns, the available GPU parallelism becomes saturated around 500000particles. By not exceeding this amount, the simulation can complete in a reasonable amount of time and still yield significant results.

Frequency Response
In order to compare the accuracy of RFKO slow extraction simulations to measurements taken from the implementation on the real machine, analytical tools established by previous work  were used to measure the frequency response of the RFKO system. By varying the rate at which a chirp was repeated, known as the interval frequency or rep rate, the resulting spill could be characterised. 

Analysis Methodology
For the machine implementation, the spill was measured using an  gas scintillator  located in the F61 extraction line (see fig:schematic). This scintillator is measured by various devices: the interface BXSCAL was selected, which provided time-series measurements of particle counts at 18.8. The spill was measured for a range of interval frequencies using an automated script interfacing with the Java API for Parameter Control (JAPC) software at CERN. Multiple sets of data were taken for each interval frequency, for a range of peak voltages applied to the TFB kicker. 


      Example signals recorded by the BXSCAL scintillator at various rep-rate intervals.
Once the scripts completed, the BXSCAL data was retrieved from NXCALS, CERN's logging database . This time-series scintillator provides a signal proportional to the instantaneous number of particles passing through the F61 extraction line, and can, therefore, be used as the extraction rate spill signal. An example of this data can be found in fig:raw_signal, showing a range of rep-rate intervals. The time-series spill signal was then analysed using a discrete Fourier transform (DFT) to obtain the frequency response of the system. 



      [Sample rate variation of the BXSCAL scintillator device]Box-plot of the variation in sample rate of the BXSCAL device over the course of the measurement. Box shows the 25 to 75 percentile, with error bars bounding the 10 and 90 percentile. Data points outside of this range are considered outliers and shown as diamond points.
Once the DFT was computed, the interval rate for each measurement was selected, normalised by the DFT DC component (the 0 term, equivalent to the average of all samples). A peak-finding algorithm was used to identify this interval rate, allowing for a slight variation in the spill measurement frequency. Over the measurements used, the BXSCAL sample rate varied between 18.6 and 18.95 (fig:sample_rate_variation). This sample rate variation likely originates from the electrical sampling equiptment, or from changes in gas pressure . As the variation was evenly distributed around the mean value of 18.78, the DFT was largely unaffected. The peak-finding algorithm was used to identify the highest peak within a range corresponding to the inter-quartile range of sample rate variance. An example of these DFTs, with the range and selections of the peak-finding algorithm, can be seen in fig:raw_ffts.

To compensate for the "noise" level of the machine data-a result of the measurement device resolution, scintillator "after-glow", residual current ("dark current"), or readout noise-the noise level was estimated from signal regions before excitation, then subtracted from the measured frequency amplitudes. Error-bar calculations for both machine and simulation data sets were made using the variance between multiple measurements at the same parameters, the variance between all measurements, and the machine noise level.


      [Example Fourier transforms of spill signals]Example Discrete Fourier Transforms (DFT) of the spill signals in fig:raw_signal. The expected interval frequency is shown as a dashed line, and the range around which the peak-finding algorithm searched is shaded. The accepted peaks are shown in grey marks, and the selected peak is shown in red.
This selection process was found to be robust but noisy, especially at higher frequencies, where the variation in the BXSCAL sample rate has a higher impact on the accuracy of the DFT. To mitigate this, the peak-finding algorithm was run on multiple repetitions of the same parameters, and the results averaged.

This same analytical method was performed for simulations; the turn number at which a particle was lost to the aperture was recorded, along with its longitudinal  variable, defined as

where  is the relativistic Lorentz factor. This was used to reconstruct the laboratory time (in real seconds, not turn number) at which the particle was lost to the aperture-and thus considered as extracted-using the equation

where , the revolution time of the reference particle, and  is the turn at which the particle was lost. This equation can also be found in the source code for the Exciter element. The extraction time data for each particle was then used to reconstruct the time-series extraction data (lst:time_series_calculation). The same peak-finding algorithm as used for machine data was then employed to generate frequency response data for simulations.


Results of Frequency Response Analysis
fig:freq_response_machine presents the results of the analysis method described in sec:machine_freq_anal_method applied to data measured from the PS. The graphs characterise the frequency response of the spill to different chirp signal rep-rate intervals, and indicate how this frequency propagates to the output (spill). The frequency response of the RFKO system is shown for both a bunched beam (upper image) and a coasting beam (lower image). Visible in both log-log plots is a distinct low-pass filter effect, where the frequency response is reduced at higher frequencies. This effect, also observed by previous studies , results in higher frequencies being "smoothed out" by the RFKO system. 

The frequency response  of a low-pass filter can be approximated to the first order as

where  is the cutoff frequency,  is the order of the filter (which determines the steepness of the roll-off), and  is a gain constant. The frequency response curve at each gain was fitted to this function, and the fitted curve and variance error are shown in red in fig:freq_response_machine and sec:machine_freq_anal_method.

For bunched beams, the low-pass filter was found to have a cutoff frequency of [separate-uncertainty = true]1.14(0.173) in machine measurements, and [separate-uncertainty = true]1.49(0.257) in simulation. Both machine measurement and simulation fits resulted in an order of exactly 1, to 7 decimal places. These results show that the frequency characteristics of the bunched-beam RFKO simulations are accurate to the machine implementation.

For coasting beams, the fitted low-pass filter has a cutoff frequency of [separate-uncertainty = true]1.12(0.190) in machine measurements, and [separate-uncertainty = true]5.26(1.03). While these results have a significantly larger error than the bunched beam results, they are still in agreement with each other. The filter order , however, is not consistent between simulation and measurements: in simulation, the curve is fit to , a very steep roll-off; for the machine measurements, the curve is fit to .

Both plots also show a minimum transfer characteristic, where the frequency response is at its lowest: for bunched beams, this minima is at 4, meaning a chirp signal repeating every 0.25 will have the least effect on frequencies present in the spill signal. For coasting beams, this minima is less clear, and appears to shift to higher frequencies with increasing chirp signal voltage.

The low-pass filter effect, and corresponding cutoff frequency and minimum transfer characteristics, can be explained by the time taken for particles to move from a stable phase-space area to the magnetic septum . This time , in units of 3 turns, is known as the transit time, and is given by :
 
The first fraction within the logarithm, where , accounts for the time taken to move from a fixed point  to the magnetic septum, where the distance between the edge of the stable phase-space area and the septum is , and the distance between the edge of the stable phase-space area enclosed by the separatrices and its center is . The second fraction, where  was defined as the modified tune distance in eq:spiral_step and eq:spiral_kick, accounts for time taken to move along the side of a stable triangle to the fixed point . fig:transit_time illustrates this transit time in phase-space.


      [Phase-space digram of extracted particle transit time]A phase-space diagram illustrating the transit time  elapsed between leaving the last stable triangle and arriving at the septum. The particle motion (and transit time) is presented in units of three turns; in real-time, the particle moves between the three separatrix arms. The Kobayashi Hamiltonian forms the separatrices of the stable triangle. Total transit time  depends both on the distance  of the particle from a fixed point  () and the distance from  to the septum blade ().
In a machine with a chromatic tune spread, this transit time  will have a spread of values , which represents a time interval within which particles which leave the stable phase space simultaneously will arrive at the septum. This results in a limiting frequency , above which frequencies in the spill structure are "washed out". 
The spread of transit times is therefore approximated to  where  is the mean modified tune distance. 
The consequence of this transit time spread is a spread in septum arrival time between instantaneously excited particles. Should the chirp repetition period be shorter than this interval, the chirp repetition frequency component will be "washed out" in the spill structure.

The simulated frequency response characteristics are shown in fig:freq_response_sim, using the same parameter ranges as fig:freq_response_machine. The bunched beam frequency response shows the same minima characteristic as the real machine, with a minimum at 4. The coasting beam simulations, however, do not have the same accuracy. The frequency response minima seen in machine_rf_off is still present at 4, but the typical low-pass filter effect is not seen, with the response returning to a high level as the chirp frequency approaches 10.


    [b]0.9
        Frequency response of machine measurements with a bunched beam.    [b]0.9
        Frequency response of machine measurements with a coasting beam.    [Measured RFKO frequency response]Frequency response of the RFKO system as implemented in the PS, both with a bunched beam (upper image) and coasting beam (lower image).

    [b]0.9
        Frequency response of simulations with a bunched beam.    [b]0.9
        Frequency response of simulations with a coasting beam.    [Simulated RFKO frequency response]Frequency response of the RFKO system as simulated in Xsuite, both with a bunched beam (upper image) and coasting beam (lower image).
fig:simvmeas_bunched and fig:simvmeas_coasting directly compare the frequency response between empirical measurements and simulations, 
for both bunched and coasting beams. These graphs present the average response curve between different voltages, and the fitted low-pass filter model, with the cutoff frequency  marked. While less pronounced in a log-log graph, the similarities in the response frequency for bunched beams is clearly seen in fig:simvmeas_bunched. For coasting beams (fig:simvmeas_coasting), this similarity is poorly observed, motivating the conclusion that-while the low-pass filter is still present-the coasting beam simulations were innaccurate.   


      [Comparisons of machine and simulation data of RFKO with bunched beams]Graph comparing the averaged frequency response curves for bunched beams between machine data (black) and simulations (red). Shaded is the  error, dashed is the fitted low-pass filter model, and vertical dashed is the calculated cutoff frequency  and the  error.

      [Comparisons of machine and simulation data of RFKO with coasting beams]Graph comparing the averaged frequency response curves for coasting beams between machine data (black) and simulations (red). Shaded is the  error, dashed is the fitted low-pass filter model, and vertical dashed is the calculated cutoff frequency  and the  error.
Spill Duty Factor
Another analytical tool for quantifying slow extraction spill quality established by previous work is the spill duty factor. This quantity is defined as  where  denotes the average of an arbitrary variable . By calculating this quantity within a rolling time window, a rolling average of spill quality can be calculated. fig:sdf_example presents an example of these calculations for the spill signals in fig:raw_signal: a flatter spill will produce a duty factor closer to , while a highly pulsed spill approaches .


      [Example spill duty factor calculations]Example rolling spill duty factor () of the spill signals in fig:raw_signal. Calculations made with 10, 50, and 1000 turn windows.
 fig:sdf_meas shows measurements of spill duty factor for both bunched (top) and coasting (bottom) beam RFKO spills, over a range of TFB signal voltages and chirp repetition frequencies. These are presented in a heatmap, where the lightness of the cell represents a higher spill duty factor, and thus a flatter spill. Qualitative analysis identifies regions where the spill quality is optimised (high ), making for optimal parameter selection. For bunched beams, the area of optimal spill quality is large, with a maximum duty factor . For coasting beams, the region of optimal spill quality is much smaller, with a maximum duty factor . Previous work on optimising slow extraction at the PS supports this finding of increased spill duty factor with RF cavities enabled, compared to beams with RF cavities disabled .

The mechanism behind the spill duty factor improvement with bunching can be understood by examining how the stable phase space behaves with respect to synchrotron oscillation. As covered in sec:long_phase_space, particles moving within longitudinal RF buckets will undergo longitudinal oscillations around the synchronous particle, known as synchrotron oscillations(As opposed to the transverse betatron oscillations.). This can be calculated as
 where  is the RF harmonic,  the RF voltage,  the particle charge,  the slip factor (eq:slip_factor),  the synchronous phase, and  the total energy. It can also be found by simulation; for the configuration outlined in preceding sections, the synchrotron tune was found to be . 
In a Steinbach diagram (sec:steinbach), this has the effect of shifting the particle horizontally, in addition to the vertical push from the exciter. This has two consequences: the particles remain at the edge of the unstable region for a shorter amount of time, as the synchrotron motion changes the particle's tune enough to move it into resonance, reducing the effect of the excitation structures. Additionally, it can reduce the effect of magnet ripples changing the shape of the unstable region.


      [Phase-space diagram of bunched beam effect on sextupole ripple]Phase space of a particle approaching the separatrix in a coasting beam (top) and a bunched beam (bottom), both with a small sextupole ripple component.
  
To see this, we will consider the two cases of a particle approaching resonance in a coasting beam and in a bunched beam, visualised in phase space in fig:synch-phase-space. The upper figure is the case for a coasting beam with no synchrotron motion: particles experience no change in tune, and so a small ripple in sextupole field could increase the stable region area and "recapture" the particle back into the stable region, preventing the particle's extraction. The lower figure describes the case for a bunched beam with slow synchrotron motion: the particles receive a kick (RFKO) and and periodic tune change (RF cavity), which reduces the stable phase-space area. This reduces the chance of a particle being recaptured by a sextupole ripple, pushes the particle deeper into resonance quicker, and "smoothens" out the spill signal. There is, however, a limit to this ripple mitigation, where the synchrotron oscillation is too fast for particles to remain in the unstable region. .

This synchrotron motion also effects the extraction transit time. The distance of a particle from the separatrix while in the unstable region grows with each synchrotron period. This reduces the transit time. Therefore, there exists an optimum synchrotron tune, where particles are more likely to remain within the unstable region, but the transit time remains long enough to smoothen the spill "pulses" between successive excitations (fig:sdf_example). Both of these effects, and the limiting frequency obtained from transit time spread, contribute to the optimal selection of parameters for an RFKO driving signal.


    [b]0.9
        Spill duty factor heatmap for bunched beam as measured in the machine.    [b]0.9
        Spill duty factor heatmap for coasting beam as measured in the machine.    [Spill duty factor heatmaps for bunched and coasting beams]Spill duty factor () heatmaps for the RFKO system as measured in the machine, both with a bunched beam (upper image) and coasting beam (lower image), as a function of chirp repetition frequency (log-scale) and voltage (linear). Color scale represents .

Conclusion

This thesis presents a number of developments towards the operational implementation of Radio Frequency Knockout (RFKO) slow extraction at CERN's Proton Synchrotron (PS) for the East experimental area (EA). Within the goal of producing low intensity, high charge, high energy, and long duration spills for fixed target experiments, the implementation of RFKO presented shows promising spill frequency structure and duty factor performance. The results of machine studies presented in results:freq_response and results:sdf use both time-domain and frequency-domain analysis to show that the system is capable of producing spills with a flat frequency structure at durations significantly longer than 100000turns, and with spill duty factors of up to 80 for bunched beams, and 60 for coasting beams.

This thesis also demonstrates significant agreement between the frequency response of this RFKO implementation and the characteristics observed in previous studies . This agreement is also well-observed between the real machine and simulations with a bunched beam, where both datasets place the optimum repetition frequency (minimising the presence of this frequency in the spill) for a RFKO-driving chirp signal between 2 and 4. This finding motivates the development of a dedicated signal generator for the PS TFB system for use with RFKO. 
This agreement is less well-observed for coasting beams, where the simulations show lower frequency response minima than machine observations. 

The implementation of RFKO simulations in Xsuite presented in sec:rfko_sim also show significant performance improvements over previous work simulating Slow Extraction at the SPS with MAD-X . By exploiting GPU accelerated computing provided by Xsuite's compatibility with CuPy, CERN's batch-processing service, and containerised environments, the simulations presented in this thesis are up to 400 times more performant in real-world simulation time than CPU-based methods.

Outlook

There are several opportunities for improvements presented in this thesis, both for potential future studies, and for the operational implementation of RFKO at the PS:

  As mentioned in sec:septum, only one of the magnetic septa-SMH57-was modelled for extraction. The accuracy of the simulation model would benefit from future development to simulate particles through both the septa and into the F61 line. This would require combining the PS optics models with the F61 optics models provided by acc-models-tls .
  The setup of the AFG used to generate chirp signals with repetition rates below 1 (sec:magcycle) was only a temporary solution, and is not suitable for long-term operational use, as it operates entirely independently from the LHC Software Architecture  (LSA) database. A dedicated signal generator, with an interface to CERN's Technical Network and LSA would be a significant improvement.
  The extraction procedure outlined in this thesis only used frequency-modulated chirp signals to sweep across the range of particle tunes. Other work has used signals such as coloured noise . These signals, and others such as dual-band frequencies, could be explored in future studies, using the same equipment and methods as presented in this thesis.
  In addition to frequency-modulation control, amplitude-modulation control has been studied in the past, and can offer improvements in macro-scale spill structure . This technique could be used to mitigate the exponential decay seen in all spill structures presented in this thesis, and extend spill times to durations significantly longer than 0.5.
  While simulations for bunched beams show good agreement with the machine implementation, the results of coasting (debunched) beams are less clear. The longitudinal dynamics of the coasting beams in RFKO would require further characterisation to fully understand the differences between the simulations and the machine.


Acknowledgements


abbrvurlcust

 












Code Listings

[captionpos=t, language=python, label=lst:kick_angle, caption=Python code to calculate angle kick produced by the TFB system (sec:trans_exc).]code/kick_angle.py

[captionpos=t, language=python, label=lst:generate_chirp, caption=Python code to generate a single chirp signal as produced by the Arbitrary Function Generator (eq:both-chirps).]code/generate_chirp.py
[captionpos=t, language=python, label=lst:time_series_calculation, caption=Python code used to calculate the laboratory time of particle extraction and reconstruct the time-series spill array (sec:machine_freq_anal_method).]code/time_series.py


